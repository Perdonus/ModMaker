__id__ = "pocket_mode"
__name__ = "Pocket Mode"
__description__ = "–ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ª—É—á–∞–π–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π, –∫–æ–≥–¥–∞ —Ç–µ–ª–µ—Ñ–æ–Ω –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∫–∞—Ä–º–∞–Ω–µ."
__author__ = "@swagnonher"
__version__ = "1.0"
__icon__ = "lock_outline"
__dependencies__ = ["mandre_lib"]

from base_plugin import BasePlugin, HookResult, HookStrategy
from ui.bulletin import BulletinHelper
import traceback

try:
    from mandre_lib import Mandre
except ImportError:
    Mandre = None

class PocketModePlugin(BasePlugin):
    def on_plugin_load(self):
        if not Mandre:
            self.log("–û—à–∏–±–∫–∞: MandreLib –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.")
            return
        
        Mandre.use_persistent_storage(self)

        self.is_in_pocket = False
        self._restart_sensor_system()
        self.add_on_send_message_hook()
        self.log("Pocket Mode: –ó–∞—â–∏—Ç–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞.")

    def on_plugin_unload(self):
        if Mandre:
            Mandre.Sensors.stop_all()

    def _restart_sensor_system(self):
        Mandre.Sensors.stop_all()
        
        custom_id_str = self.get_setting("custom_sensor_id", "0")
        try:
            custom_id = int(custom_id_str)
        except:
            custom_id = 0

        if custom_id > 0:
            Mandre.Sensors.set_override(8, custom_id)
        else:
            Mandre.Sensors.set_override(8, 8)

        if self.get_setting("active", True):
            try:
                Mandre.Sensors.listen_proximity(self._on_sensor_data)
            except Exception as e:
                self.log(f"–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å–µ–Ω—Å–æ—Ä–∞: {e}")

    def create_settings(self):
        return Mandre.Settings.render(self, f"""
            <header text="–û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏" align="center" />
            <switch key="active" text="–í–∫–ª—é—á–∏—Ç—å –∑–∞—â–∏—Ç—É" subtext="–ë–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É –≤ –∫–∞—Ä–º–∞–Ω–µ" default="true" icon="proxy_on_solar" />
            <switch key="visual_feedback" text="–í–∏–∑—É–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å" subtext="–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –¥–∞—Ç—á–∏–∫–∞" default="true" icon="msg_info" />

            <header text="–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è" align="center" />
            <text text="–ï—Å–ª–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç" subtext_color="windowBackgroundWhiteGrayText" subtext="—à–∞–≥ 1: —Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –¥–∞—Ç—á–∏–∫–∏, —à–∞–≥ 2: –ø—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–æ–≤—ã–π ID" />
            
            <input key="custom_sensor_id" text="ID –î–∞—Ç—á–∏–∫–∞" subtext="0 = –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ ID –≤—Ä—É—á–Ω—É—é." default="0" icon="hardware_cpu_solar" />
            
            <button text="–ü—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–æ–≤—ã–π ID" icon="msg_retry" on_click="apply_id" />
            <button text="üîç –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –¥–∞—Ç—á–∏–∫–∏ –≤ –ª–æ–≥" icon="msg_search" on_click="scan_sensors" />
        """)

    def scan_sensors(self):
        sensors = Mandre.Sensors.get_all_sensors_info()
        self.log("=== SCANNING SENSORS ===")
        found_candidate = None
        
        for s in sensors:
            sid = s.get('id')
            name = s.get('name', 'Unknown')
            is_prox = "prox" in name.lower() or "distance" in name.lower() or "tmd" in name.lower()
            
            prefix = "‚úÖ " if is_prox else "‚ñ™Ô∏è "
            self.log(f"{prefix}ID: {sid} | Name: {name}")
            
            if is_prox and not found_candidate:
                found_candidate = sid

        if found_candidate:
            self.set_setting("custom_sensor_id", str(found_candidate))
            Mandre.apply_and_refresh_settings(self)
            BulletinHelper.show_success(f"–ù–∞–π–¥–µ–Ω –∏ –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω ID: {found_candidate}")
        else:
            BulletinHelper.show_info("–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –°–º. –ª–æ–≥–∏.")

    def apply_id(self):
        self._restart_sensor_system()
        BulletinHelper.show_success("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ–Ω—Å–æ—Ä–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã")

    def _on_sensor_data(self, data):
        raw_val = data.get("cm", 0.0)

        is_near = (raw_val < 1.0) 
        
        if self.is_in_pocket != is_near:
            self.is_in_pocket = is_near

            if self.get_setting("visual_feedback", True):
                state = "üü• –ó–ê–ö–†–´–¢ (–ë–ª–æ–∫)" if is_near else "üü© –û–¢–ö–†–´–¢"
                BulletinHelper.show_info(f"–î–∞—Ç—á–∏–∫: {state}")

    def on_send_message_hook(self, *args):
        try:
            if not self.get_setting("active", True):
                return HookResult()

            if self.is_in_pocket:
                BulletinHelper.show_error("üö´ –ó–∞—â–∏—Ç–∞ –æ—Ç –∫–∞—Ä–º–∞–Ω–∞: –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞")
                return HookResult(strategy=HookStrategy.CANCEL)

            return HookResult()
            
        except Exception:
            return HookResult()