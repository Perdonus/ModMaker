__id__ = "JakeAI"
__name__ = "Jake AI"
__author__ = "@jakekson (@jakekkson)"
__version__ = "1.0.1"
__description__ = """–ò–ò –ø–æ–º–æ—â–Ω–∏–∫
- –†–∞–±–æ—Ç–∞–µ—Ç —Å —Ç–µ–∫—Å—Ç–æ–º
- –î–æ–±–∞–≤–ª—è–µ—Ç –∫–Ω–æ–ø–∫—É –≤ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ
- –¢–∞–∫–∂–µ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å —Å–≤–æ–∏ —Ñ—É–Ω–∫—Ü–∏–∏ (—Ä–æ–ª–∏ –ò–ò)
.ai / .–∏–∏ (–≤–æ–ø—Ä–æ—Å) - —Å–ø—Ä–æ—Å–∏—Ç—å –≤–æ–ø—Ä–æ—Å —É –ò–ò"""

__icon__ = "sPluginIDE/4"
__min_version__ = "11.12.0"

import requests
import json
import threading
import traceback
from typing import Any, Dict, List
import copy

from base_plugin import BasePlugin, MenuItemData, MenuItemType, HookResult, HookStrategy
from client_utils import get_last_fragment
from android_utils import run_on_ui_thread, log
from ui.settings import Header, Input, Selector, Divider, Text
from ui.bulletin import BulletinHelper
from ui.alert import AlertDialogBuilder
from org.telegram.messenger import MessageObject, AndroidUtilities
from com.exteragram.messenger.plugins import PluginsController
from com.exteragram.messenger.plugins.ui import PluginSettingsActivity

# API URL –¥–ª—è OpenRouter
OPENROUTER_API_URL = "https://openrouter.ai/api/v1/chat/completions"

class ChatSummarizerPlugin(BasePlugin):
    """
    –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —Å –ø–æ–º–æ—â—å—é –ò–ò –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —É–¥–æ–±–Ω–æ–º –æ–∫–Ω–µ.
    """
    MODEL_IDS = [
        "z-ai/glm-4.5-air:free",
        "openai/gpt-oss-20b:free",
        "cognitivecomputations/dolphin-mistral-24b-venice-edition:free",
        "shisa-ai/shisa-v2-llama3.3-70b:free",
        "meta-llama/llama-4-maverick:free",
        "moonshotai/kimi-k2:free",
    ]
    MODEL_NAMES = [
        "GLM-4.5-Air (Free)",
        "GPT-OSS-20B (Free)",
        "Dolphin Mistral 24B (Free)",
        "Shisa V2 Llama3.3 70B (Free)",
        "Llama 4 Maverick (Free)",
        "Kimi K2 (Free)",
    ]

    DEFAULT_ROLES = {
        "summarize": {"name": "–ö—Ä–∞—Ç–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ", "prompt": "–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –≤ –∫—Ä–∞—Ç–∫–æ–º –∏–∑–ª–æ–∂–µ–Ω–∏–∏. –ù–∞–ø–∏—à–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∫—Ä–∞—Ç–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π Markdown –∏ —Ç–∞–±–ª–∏—Ü—ã."},
        "fix_grammar": {"name": "–ò—Å–ø—Ä–∞–≤–∏—Ç—å –≥—Ä–∞–º–º–∞—Ç–∏–∫—É", "prompt": "–¢—ã ‚Äî —Ä–µ–¥–∞–∫—Ç–æ—Ä. –ò—Å–ø—Ä–∞–≤—å –≤—Å–µ –≥—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∏ –æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –≤ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–º —Ç–µ–∫—Å—Ç–µ."},
        "translate_en": {"name": "–ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π", "prompt": "–¢—ã ‚Äî –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫. –ü–µ—Ä–µ–≤–µ–¥–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫."},
        "explain_eli5": {"name": "–û–±—ä—è—Å–Ω–∏—Ç—å –ø—Ä–æ—Å—Ç–æ", "prompt": "–û–±—ä—è—Å–Ω–∏ –∏–¥–µ—é –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ —Ç–∞–∫, –∫–∞–∫ –±—É–¥—Ç–æ –æ–±—ä—è—Å–Ω—è–µ—à—å –µ—ë –ø—è—Ç–∏–ª–µ—Ç–Ω–µ–º—É —Ä–µ–±—ë–Ω–∫—É."}
    }
    
    def __init__(self):
        super().__init__()
        self.progress_dialog = None

    def on_plugin_load(self):
        self.add_on_send_message_hook() # –•—É–∫ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥
        self.add_menu_item(MenuItemData(
            menu_type=MenuItemType.DRAWER_MENU, 
            text="Jake AI", 
            icon="msg_settings_ny", 
            on_click=lambda c: self._open_plugin_settings()
        ))
        self.add_menu_item(MenuItemData(
            menu_type=MenuItemType.MESSAGE_CONTEXT_MENU, 
            text="–û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å –ò–ò", 
            icon="ai_chat_solar", 
            on_click=self.on_process_message_click, 
            condition="message.messageOwner.message != null && !message.messageOwner.message.isEmpty()"
        ))

    def on_send_message_hook(self, account: int, params: Any) -> HookResult:
        if not hasattr(params, 'message') or not isinstance(params.message, str):
            return HookResult()
            
        msg = params.message.strip()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–º–∞–Ω–¥—ã .ai –∏ .–∏–∏
        if msg.lower().startswith(".ai ") or msg.lower().startswith(".–∏–∏ "):
            question = msg[msg.find(" ") + 1:].strip()
            if not question:
                return HookResult() # –ï—Å–ª–∏ –ø–æ—Å–ª–µ –∫–æ–º–∞–Ω–¥—ã –Ω–µ—Ç —Ç–µ–∫—Å—Ç–∞, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º

            self.start_processing_question(question)
            return HookResult(strategy=HookStrategy.CANCEL)
            
        return HookResult()

    def _load_custom_roles(self) -> List[Dict]:
        try:
            roles_json = self.get_setting("custom_roles_json", "[]")
            return json.loads(roles_json) if isinstance(roles_json, str) else []
        except (json.JSONDecodeError, TypeError):
            return []

    def _save_custom_roles(self, roles: List[Dict]):
        self.set_setting("custom_roles_json", json.dumps(roles))

    def _get_all_roles(self) -> Dict:
        all_roles = copy.deepcopy(self.DEFAULT_ROLES)
        for i, role in enumerate(self._load_custom_roles()):
            all_roles[f"custom_{i}"] = role
        return all_roles
        
    def _refresh_settings_page(self):
        fragment = get_last_fragment()
        if fragment and hasattr(fragment, "rebuildAllFragments"):
            run_on_ui_thread(lambda: fragment.rebuildAllFragments(True))
            
    def _open_plugin_settings(self, context: dict = None):
        def action():
            try:
                java_plugin = PluginsController.getInstance().plugins.get(self.id)
                if java_plugin and (fragment := get_last_fragment()):
                    fragment.presentFragment(PluginSettingsActivity(java_plugin))
            except Exception as e:
                log(f"[{self.id}] –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: {e}")
        run_on_ui_thread(action)

    def create_settings(self):
        settings = [
            Header(text="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ API"),
            Input(key="api_key", text="API –ö–ª—é—á OpenRouter", default="", subtext="–ü–æ–ª—É—á–∏—Ç–µ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–ª—é—á –Ω–∞ OpenRouter.ai", icon="menu_username_set_solar"),
            Selector(key="model_index", text="–ú–æ–¥–µ–ª—å –ò–ò", items=self.MODEL_NAMES, default=0, icon="msg_folders_bots_solar"),
            Header(text="–ö–æ–º–∞–Ω–¥–∞ .ai/.–∏–∏"),
            Input(key="prompt_ask_ai", text="–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è .ai", default="–û—Ç–≤–µ—á–∞–π –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∫—Ä–∞—Ç–∫–æ, –±–µ–∑ Markdown –∏ —Ç–∞–±–ª–∏—Ü.", icon="msg_ask_question_solar"),
            Divider(),
            Header(text="–†–æ–ª–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–¥–ª—è –º–µ–Ω—é —Å–æ–æ–±—â–µ–Ω–∏—è)")
        ]
        
        for key, data in self.DEFAULT_ROLES.items():
            settings.append(Input(key=f"prompt_{key}", text=f"–ü—Ä–æ–º–ø—Ç –¥–ª—è '{data['name']}'", default=data['prompt'], icon="msg_edit_solar"))
        
        settings.append(Divider())
        settings.append(Header(text="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ä–æ–ª–∏"))
        
        for i, role in enumerate(self._load_custom_roles()):
            settings.extend([
                Input(key=f"custom_role_name_{i}", text=f"–ò–º—è —Ä–æ–ª–∏ #{i+1}", default=role.get('name', ''), on_change=lambda val, idx=i: self._update_custom_role(idx, 'name', val)),
                Input(key=f"custom_role_prompt_{i}", text=f"–ü—Ä–æ–º–ø—Ç —Ä–æ–ª–∏ #{i+1}", default=role.get('prompt', ''), on_change=lambda val, idx=i: self._update_custom_role(idx, 'prompt', val)),
                Text(text="–£–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ä–æ–ª—å", icon="msg_delete", red=True, on_click=lambda v, idx=i: self._remove_role(idx))
            ])
            
        settings.append(Divider())
        settings.append(Text(text="–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é —Ä–æ–ª—å", icon="msg_add_file", accent=True, on_click=lambda v: self._add_role()))
        return settings

    def _add_role(self):
        roles = self._load_custom_roles()
        roles.append({"name": "–ù–æ–≤–∞—è —Ä–æ–ª—å", "prompt": ""})
        self._save_custom_roles(roles)
        self._refresh_settings_page()

    def _remove_role(self, index: int):
        roles = self._load_custom_roles()
        if 0 <= index < len(roles):
            roles.pop(index)
            self._save_custom_roles(roles)
            self._refresh_settings_page()

    def _update_custom_role(self, index: int, field: str, value: str):
        roles = self._load_custom_roles()
        if 0 <= index < len(roles):
            roles[index][field] = value
            self._save_custom_roles(roles)

    def on_process_message_click(self, context: Dict[str, Any]):
        message_obj = context.get("message")
        if not (message_obj and message_obj.messageOwner and message_obj.messageOwner.message):
            BulletinHelper.show_error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è.")
            return

        fragment = get_last_fragment()
        activity = fragment.getParentActivity() if fragment else None
        if not activity: return

        all_roles = self._get_all_roles()
        role_names = [role['name'] for role in all_roles.values()]
        
        def on_role_selected(builder, index):
            role_key = list(all_roles.keys())[index]
            role_data = all_roles.get(role_key)
            system_prompt = self.get_setting(f"prompt_{role_key}", role_data["prompt"]).strip()
            self.start_processing(message_obj.messageOwner.message, system_prompt, role_data["name"])
            builder.dismiss()

        builder = AlertDialogBuilder(activity)
        builder.set_title("–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ")
        builder.set_items(role_names, on_role_selected)
        builder.show()

    def _show_progress_dialog(self, title: str):
        def action():
            self._dismiss_progress_dialog()
            fragment = get_last_fragment()
            activity = fragment.getParentActivity() if fragment else None
            if not activity: return
            
            builder = AlertDialogBuilder(activity, AlertDialogBuilder.ALERT_TYPE_SPINNER)
            builder.set_title(title)
            builder.set_message("–ñ–¥–∏—Ç–µ...")
            builder.set_cancelable(False)
            self.progress_dialog = builder.show()
        run_on_ui_thread(action)

    def _dismiss_progress_dialog(self):
        def action():
            if self.progress_dialog and self.progress_dialog.get_dialog() and self.progress_dialog.get_dialog().isShowing():
                self.progress_dialog.dismiss()
            self.progress_dialog = None
        run_on_ui_thread(action)

    def start_processing(self, message_text: str, system_prompt: str, title: str, original_question: str = None):
        api_key_pi = self.get_setting("api_key", "").strip()
        if not api_key_pi:
            BulletinHelper.show_error("API –∫–ª—é—á –Ω–µ —É–∫–∞–∑–∞–Ω!", icon="msg_info")
            self._open_plugin_settings()
            return
            
        model_index = self.get_setting("model_index", 0)
        model = self.MODEL_IDS[min(model_index, len(self.MODEL_IDS) - 1)]

        self._show_progress_dialog(f"–í—ã–ø–æ–ª–Ω—è—é: {title}")
        # —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –≤ Plugin IDE - @PluginIDE
        threading.Thread(target=self._processing_task, args=(message_text, api_key_pi, model, system_prompt, title, original_question), daemon=True).start()

    def start_processing_question(self, question: str):
        system_prompt = self.get_setting("prompt_ask_ai", "–û—Ç–≤–µ—á–∞–π –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∫—Ä–∞—Ç–∫–æ, –±–µ–∑ Markdown –∏ —Ç–∞–±–ª–∏—Ü.")
        self.start_processing(question, system_prompt, "–û—Ç–≤–µ—Ç –ò–ò", original_question=question)

    def _processing_task(self, message_text, api_key, model, system_prompt, role_title, original_question=None):
        try:
            result_text = self._call_openrouter(message_text, api_key, model, system_prompt)
            if result_text is not None:
                final_display_text = result_text
                if original_question:
                    final_display_text = f"‚ùì –í–æ–ø—Ä–æ—Å:\n{original_question}\n\nüí° –û—Ç–≤–µ—Ç:\n{result_text}"
                self._show_result_dialog(final_display_text, role_title)
        except Exception as e:
            log(f"[{self.id}] –û—à–∏–±–∫–∞ –≤ –∑–∞–¥–∞—á–µ: {e}\n{traceback.format_exc()}")
            run_on_ui_thread(lambda: BulletinHelper.show_error(f"–û—à–∏–±–∫–∞: {e}"))
        finally:
            self._dismiss_progress_dialog()

    def _call_openrouter(self, message_text: str, api_key: str, model: str, system_prompt: str) -> str:
        headers = {
            "Authorization": f"Bearer {api_key}", 
            "Content-Type": "application/json",
            "HTTP-Referer": "https://github.com/PluginIDE",
            "X-Title": "exteraGram AI Helper"
        }
        data = { "model": model, "messages": [{"role": "system", "content": system_prompt}, {"role": "user", "content": message_text}] }
        try:
            response = requests.post(OPENROUTER_API_URL, headers=headers, json=data, timeout=60)
            response.raise_for_status()
            response_json = response.json()
            result = response_json.get("choices", [{}])[0].get("message", {}).get("content", "").strip()
            if not result:
                run_on_ui_thread(lambda: BulletinHelper.show_error("–ò–ò –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç."))
                return None
            return result
        except requests.exceptions.RequestException as e:
            error_msg = f"–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: {e}"
            if e.response is not None:
                try: error_msg = f"–û—à–∏–±–∫–∞ API {e.response.status_code}: {e.response.json().get('error', {}).get('message', e.response.text)}"
                except json.JSONDecodeError: error_msg = f"–û—à–∏–±–∫–∞ API {e.response.status_code}: {e.response.text}"
            run_on_ui_thread(lambda: BulletinHelper.show_error(error_msg))
            return None
        except (KeyError, IndexError) as e:
            log(f"[{self.id}] –ù–µ–≤–µ—Ä–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞ API: {e}")
            run_on_ui_thread(lambda: BulletinHelper.show_error("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç –ò–ò."))
            return None

    def _show_result_dialog(self, result_text: str, title: str):
        # =^._.^=
        def show_action():
            try:
                fragment = get_last_fragment()
                activity_pi = fragment.getParentActivity() if fragment else None
                if not activity_pi: raise ValueError("Activity not found")
                
                builder = AlertDialogBuilder(activity_pi)
                builder.set_title(f"üìù {title}")
                builder.set_message(result_text)
                
                def on_copy_click(bld, which):
                    AndroidUtilities.addToClipboard(result_text)
                    BulletinHelper.show_copied_to_clipboard("–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω")

                builder.set_neutral_button("–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å", on_copy_click)
                builder.set_positive_button("–ó–∞–∫—Ä—ã—Ç—å", lambda bld, which: bld.dismiss())
                builder.show()
                BulletinHelper.show_success(f"{title}: –ì–æ—Ç–æ–≤–æ!")
            except Exception as e:
                log(f"[{self.id}] –û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞: {e}\n{traceback.format_exc()}")
                BulletinHelper.show_error("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –æ–∫–Ω–æ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º.")
        
        run_on_ui_thread(show_action)
