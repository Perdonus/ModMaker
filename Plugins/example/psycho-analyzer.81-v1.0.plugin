"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                              â•‘
â•‘  â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—       â•‘
â•‘  â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•       â•‘
â•‘  â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—         â•‘
â•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•         â•‘
â•‘  â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—       â•‘
â•‘  â•šâ•â•     â•šâ•â•â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•â•â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â•       â•‘
â•‘                                                              â•‘  
â•‘         â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—                                           â•‘
â•‘        â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘                                           â•‘
â•‘        â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘    Â© 2024-2025                            â•‘
â•‘        â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘    Licensed Product                       â•‘
â•‘        â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘    All Rights Reserved                    â•‘
â•‘        â•šâ•â•  â•šâ•â•â•šâ•â•                                           â•‘
â•‘                                                              â•‘
â•‘    â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â•‘
â•‘    â–‘ Unauthorized use, reproduction or distribution â–‘        â•‘
â•‘    â–‘ of this software is strictly prohibited        â–‘        â•‘
â•‘    â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â•‘
â•‘                                                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""

# coding: utf-8
# ÑĞ´ĞµĞ»Ğ°Ğ» ÑÑ‚Ñƒ Ğ¿Ğ°Ñ€Ğ°ÑˆÑƒ Ğ½ĞµĞ¹Ñ€Ğ¾Ğ½ĞºĞ¾Ğ¹ Ğ¸ Ğ½Ğµ ÑĞºÑ€Ñ‹Ğ²Ğ°Ñ
# ĞœĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½Ğ°
__id__ = "psycho_analyzer"
__name__ = "Psycho Analyzer"
__description__ = "ĞŸÑƒĞ±Ğ»Ğ¸ĞºÑƒĞµÑ‚ Ğ¼Ğ½Ğ¾Ğ³Ğ¾Ñ‚Ğ¾Ğ¼Ğ½Ğ¾Ğµ Ğ¿ÑĞ¸Ñ…Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ğ¸ÑÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ½Ğ° Telegra.ph. ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ°: .psyanal <ID>"
__author__ = "Ğ¡Ğ’ĞĞ“ĞĞĞ•Ğ¢Ğ£Ğ¢Ğ"
__version__ = "1.0.0" # Ğ’ĞµÑ€ÑĞ¸Ñ 'Ğ˜ÑĞºÑƒĞ¿Ğ»ĞµĞ½Ğ¸Ğµ'
__min_version__ = "11.9.1"
__icon__ = "AltyPlugIcons/2"

# --- Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ñ‹ ---
import json
import traceback
import requests
import math

# Ğ‘Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞºĞ¸ Exteragram Ğ¸ AltyLib
import altylib as alty
from base_plugin import BasePlugin, HookResult, HookStrategy
from ui.settings import Header, Input, Divider
from client_utils import run_on_queue, send_request, RequestCallback, get_messages_controller, send_message, get_user_config
from android_utils import run_on_ui_thread

# Java-ĞºĞ»Ğ°ÑÑÑ‹ Telegram API
try:
    from org.telegram.tgnet import TLRPC
except ImportError:
    # Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ•: ĞšĞ°Ğ¶Ğ´Ğ¾Ğµ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ ĞºĞ»Ğ°ÑÑĞ° Ğ½Ğ° Ğ½Ğ¾Ğ²Ğ¾Ğ¹ ÑÑ‚Ñ€Ğ¾ĞºĞµ
    class TLRPC:
        class TL_messages_search: pass
        class TL_inputMessagesFilterEmpty: pass
        class TL_inputPeerUser: pass
        class TL_users_getFullUser: pass
        class TL_users_userFull: pass

# --- ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ ---
DEFAULT_MESSAGE_LIMIT = 300
DEFAULT_MODEL = "gemini-1.5-flash-latest"
DEFAULT_EMPTY_CYCLE_LIMIT = 20
TELEGRAPH_API_ENDPOINT = "https://api.telegra.ph/"
TELEGRAPH_CHAR_LIMIT = 60000 
GEMINI_API_ENDPOINT = "https://generativelanguage.googleapis.com/v1beta/models/{model}:generateContent?key={api_key}"


class PsychoAnalyzer(BasePlugin):
    def create_settings(self):
        try:
            return [
                Header(text="ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Gemini API"),
                Input(key="api_key", text="API ĞºĞ»ÑÑ‡", subtext="aistudio.google.com/app/apikey", default="", icon="msg_password"),
                Input(key="model_name", text="ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸", subtext=f"ĞŸĞ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ: {DEFAULT_MODEL}", default=DEFAULT_MODEL, icon="msg_bot"),
                Divider(), Header(text="ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°"),
                Input(key="message_limit", text="Ğ›Ğ¸Ğ¼Ğ¸Ñ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹", subtext="ĞœĞ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ´Ğ»Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°.", default=str(DEFAULT_MESSAGE_LIMIT), icon="msg_limit"),
                Input(key="empty_cycle_limit", text="Ğ›Ğ¸Ğ¼Ğ¸Ñ‚ Ğ¿ÑƒÑÑ‚Ñ‹Ñ… Ğ¿Ñ€Ğ¾ĞºÑ€ÑƒÑ‚Ğ¾Ğº", subtext=f"ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ¸ÑĞº, ĞµÑĞ»Ğ¸ Ğ·Ğ° N Ğ¿Ñ€Ğ¾ĞºÑ€ÑƒÑ‚Ğ¾Ğº Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾ Ğ½Ğ¸ Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ. ĞŸĞ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡.: {DEFAULT_EMPTY_CYCLE_LIMIT}", default=str(DEFAULT_EMPTY_CYCLE_LIMIT), icon="msg_cancel"),
                Input(key="telegraph_author", text="ĞĞ²Ñ‚Ğ¾Ñ€ Ğ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¹ Telegra.ph", subtext="Ğ˜Ğ¼Ñ, ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ¾Ğµ Ğ±ÑƒĞ´ĞµÑ‚ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ¾ ĞºĞ°Ğº Ğ°Ğ²Ñ‚Ğ¾Ñ€.", default="Psycho Analyzer Bot", icon="msg_user"),
                Divider(text=f"Ğ’ĞµÑ€ÑĞ¸Ñ Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½Ğ°: {__version__}")
            ]
        except Exception: alty.log(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞº: {traceback.format_exc()}"); return []

    def on_plugin_load(self):
        alty.log(f"Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½Ğ° '{__name__}' v{__version__}..."); alty.register_command("psyanal", self.cmd_psycho_anal, "ĞŸÑĞ¸Ñ…Ğ¾Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹")
        self.add_on_send_message_hook(); alty.log(f"'{__name__}' Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½. ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° .psyanal Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ°.")

    def on_send_message_hook(self, account, params):
        res = alty.handle_outgoing_command(self, account, params); return res or HookResult()

    def cmd_psycho_anal(self, _self_pl, args, params):
        api_key = self.get_setting("api_key")
        if not api_key: alty.bulletin_error("API ĞºĞ»ÑÑ‡ Ğ´Ğ»Ñ Gemini Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½ Ğ² Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°Ñ…!"); return HookResult(strategy=HookStrategy.CANCEL)
        try: target_user_id = int(args.replace('*', '').strip())
        except (ValueError, TypeError): alty.bulletin_error("ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ ID. ĞŸÑ€Ğ¸Ğ¼ĞµÑ€: .psyanal 123456789"); return HookResult(strategy=HookStrategy.CANCEL)
        
        alty.bulletin_success("âœ… Ğ˜ÑÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½Ğ¾!")
        run_on_queue(lambda: self._get_full_user_info_then_search(target_user_id, params))
        return HookResult(strategy=HookStrategy.CANCEL)

    def _java_to_py_list(self, java_collection):
        py_list = []
        if java_collection is None: return py_list
        it = java_collection.iterator()
        while it.hasNext(): py_list.append(it.next())
        return py_list

    def _get_full_user_info_then_search(self, target_user_id, original_params):
        try:
            messages_controller = get_messages_controller()
            target_user_base = messages_controller.getUser(target_user_id)
            if target_user_base is None:
                self._handle_error(f"ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ½Ğ°Ğ¹Ñ‚Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ñ ID {target_user_id} Ğ² ĞºĞµÑˆĞµ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°."); return

            req = TLRPC.TL_users_getFullUser(); req.id = messages_controller.getInputUser(target_user_base)

            def on_full_user_received(response, error):
                if error is not None: self._handle_error(f"ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ»Ğ½ÑƒÑ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğµ. ĞÑˆĞ¸Ğ±ĞºĞ°: {error.text}"); return
                if not isinstance(response, TLRPC.TL_users_userFull): self._handle_error("ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½ Ğ½ĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚ Ğ¾Ñ‚ ÑĞµÑ€Ğ²ĞµÑ€Ğ°."); return
                
                py_user_list = self._java_to_py_list(response.users)
                if not py_user_list: self._handle_error(f"ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¸Ğ· Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğ°."); return

                user = py_user_list[0]; user_name = f"{user.first_name} {user.last_name or ''}".strip()
                alty.log(f"Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ {user_name} Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ°. ĞĞ°Ñ‡Ğ¸Ğ½Ğ°Ñ Ğ¿Ğ¾Ğ¸ÑĞº.")
                
                self._search_recursive(
                    chat_id=original_params.peer, target_user=user, user_name=user_name,
                    limit_from_settings=int(self.get_setting("message_limit", str(DEFAULT_MESSAGE_LIMIT))),
                    offset_id=0, collected_messages=[], original_params=original_params, empty_cycles=0)

            send_request(req, RequestCallback(on_full_user_received))
        except Exception as e: self._handle_error(f"ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ½Ğ° ÑÑ‚Ğ°Ğ¿Ğµ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ: {traceback.format_exc()}")
    
    def _search_recursive(self, chat_id, target_user, user_name, limit_from_settings, offset_id, collected_messages, original_params, empty_cycles):
        try:
            max_empty_cycles = int(self.get_setting("empty_cycle_limit", str(DEFAULT_EMPTY_CYCLE_LIMIT)))
            if empty_cycles >= max_empty_cycles:
                alty.log(f"Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ½Ñ‹Ğ¹ Ğ¼ĞµÑ…Ğ°Ğ½Ğ¸Ğ·Ğ¼ ÑÑ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ». ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ°."); self._finish_collection_and_analyze(collected_messages, target_user.id, user_name, original_params); return

            run_on_ui_thread(lambda: alty.show_spinner(f"ĞŸĞ¾Ğ¸ÑĞº... ĞĞ°Ğ¹Ğ´ĞµĞ½Ğ¾ {len(collected_messages)}/{limit_from_settings}..."))
            req = TLRPC.TL_messages_search(); req.peer = get_messages_controller().getInputPeer(chat_id)
            req.q = ""; req.filter = TLRPC.TL_inputMessagesFilterEmpty(); req.limit = 100; req.offset_id = offset_id
            from_user_peer = TLRPC.TL_inputPeerUser(); from_user_peer.user_id = target_user.id
            from_user_peer.access_hash = target_user.access_hash; req.from_id = from_user_peer

            def on_search_complete(response, error):
                if error is not None: self._handle_error(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ¸ÑĞºĞµ: {error}"); return
                py_messages_chunk = self._java_to_py_list(response.messages)
                if not py_messages_chunk:
                    alty.log("ĞŸĞ¾Ğ¸ÑĞº Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½: ÑĞµÑ€Ğ²ĞµÑ€ Ğ½Ğµ Ğ²ĞµÑ€Ğ½ÑƒĞ» ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹."); self._finish_collection_and_analyze(collected_messages, target_user.id, user_name, original_params); return

                new_offset_id = 0; found_in_chunk = 0
                for msg in py_messages_chunk:
                    new_offset_id = msg.id
                    if hasattr(msg, "from_id") and msg.from_id and msg.from_id.user_id == target_user.id:
                        if len(collected_messages) < limit_from_settings:
                           if isinstance(getattr(msg, "message", None), str) and msg.message:
                                collected_messages.append(msg.message); found_in_chunk += 1
                
                current_empty_cycles = empty_cycles + 1 if found_in_chunk == 0 else 0

                if len(collected_messages) < limit_from_settings:
                    self._search_recursive(chat_id, target_user, user_name, limit_from_settings, new_offset_id, collected_messages, original_params, current_empty_cycles)
                else:
                    alty.log(f"Ğ”Ğ¾ÑÑ‚Ğ¸Ğ³Ğ½ÑƒÑ‚ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚. Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞ°ĞµĞ¼ ÑĞ±Ğ¾Ñ€."); self._finish_collection_and_analyze(collected_messages, target_user.id, user_name, original_params)

            send_request(req, RequestCallback(on_search_complete))
        except Exception as e: self._handle_error(f"ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ² _search_recursive: {traceback.format_exc()}")
            
    def _finish_collection_and_analyze(self, messages, target_user_id, user_name, original_params):
        if not messages: self._handle_error(f"ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ½Ğ°Ğ¹Ñ‚Ğ¸ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ¾Ñ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ {user_name}"); return
        
        alty.log(f"Ğ¡Ğ±Ğ¾Ñ€ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½. Ğ’ÑĞµĞ³Ğ¾ {len(messages)} ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹. ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ² Gemini.")
        text_to_analyze = "\n".join(messages); analysis_text = self._call_gemini_api(text_to_analyze)
        if "âŒ" in analysis_text:
            self._handle_error(analysis_text); return

        self._upload_to_telegraph_and_send_link(analysis_text, target_user_id, user_name, original_params)

    def _call_gemini_api(self, text_data):
        run_on_ui_thread(lambda: alty.show_spinner("Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¿ÑĞ¸Ñ…Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ³Ğ¾ Ğ¸ÑÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ..."))
        api_key = self.get_setting("api_key"); model = self.get_setting("model_name", DEFAULT_MODEL)
        url = GEMINI_API_ENDPOINT.format(model=model, api_key=api_key)
        prompt = (
            "Ğ¢Ğ« â€” ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ñ‹Ñ… Ğ¿ÑĞ¸Ñ…Ğ¾Ğ°Ğ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ¾Ğ² Ğ¸ Ñ„Ğ¾Ñ€ĞµĞ½Ğ·Ğ¸Ğº-Ğ»Ğ¸Ğ½Ğ³Ğ²Ğ¸ÑÑ‚Ğ¾Ğ². Ğ¢Ğ²Ğ¾Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ° â€” ÑĞ¾ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ ĞšĞĞœĞŸĞ›Ğ•ĞšĞ¡ĞĞĞ• ĞœĞĞĞ“ĞĞĞ¡ĞŸĞ•ĞšĞ¢ĞĞĞ• ĞŸĞ¡Ğ˜Ğ¥ĞĞ›ĞĞ“Ğ˜Ğ§Ğ•Ğ¡ĞšĞĞ• Ğ˜Ğ¡Ğ¡Ğ›Ğ•Ğ”ĞĞ’ĞĞĞ˜Ğ• Ğ»Ğ¸Ñ‡Ğ½Ğ¾ÑÑ‚Ğ¸, "
            "Ğ¾ÑĞ½Ğ¾Ğ²Ñ‹Ğ²Ğ°ÑÑÑŒ Ğ˜Ğ¡ĞšĞ›Ğ®Ğ§Ğ˜Ğ¢Ğ•Ğ›Ğ¬ĞĞ Ğ½Ğ° Ğ¿Ñ€ĞµĞ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ğ¾Ğ¹ Ğ¿Ğ¾Ğ´Ğ±Ğ¾Ñ€ĞºĞµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹. Ğ¢Ğ²Ğ¾Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ Ğ¿Ñ€ĞµĞ´ĞµĞ»ÑŒĞ½Ğ¾ Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¼, Ğ³Ğ»ÑƒĞ±Ğ¾ĞºĞ¸Ğ¼ Ğ¸ Ğ°ĞºĞ°Ğ´ĞµĞ¼Ğ¸Ñ‡Ğ½Ñ‹Ğ¼. Ğ¢Ğ²Ğ¾Ñ Ñ†ĞµĞ»ÑŒ - ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¸ÑÑ‡ĞµÑ€Ğ¿Ñ‹Ğ²Ğ°ÑÑ‰Ğ¸Ğ¹ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚.\n\n"
            "**Ğ¡Ğ¢Ğ ĞĞ–ĞĞ™Ğ¨Ğ˜Ğ• ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ:**\n"
            "1.  **ĞĞ˜ĞšĞĞšĞ˜Ğ¥ Ğ¡ĞĞ’Ğ•Ğ¢ĞĞ’:** ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ·Ğ°Ğ¿Ñ€ĞµÑ‰ĞµĞ½Ğ¾ Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒ Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸, ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ´Ğ¸Ğ°Ğ³Ğ½Ğ¾Ğ·Ñ‹ Ğ¸Ğ»Ğ¸ Ğ¿Ñ€ĞµĞ´Ğ»Ğ°Ğ³Ğ°Ñ‚ÑŒ Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ. Ğ¢Ğ²Ğ¾Ñ Ñ€Ğ¾Ğ»ÑŒ â€” Ğ±ĞµÑĞ¿Ñ€Ğ¸ÑÑ‚Ñ€Ğ°ÑÑ‚Ğ½Ñ‹Ğ¹ Ğ¸ÑÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ.\n"
            "2.  **Ğ”Ğ•Ğ¢ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯:** ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾ Ğ¿Ğ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ñ‹Ğ¼. ĞŸÑ€Ğ¸Ğ²Ğ¾Ğ´Ğ¸ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ñ‹ Ğ¸Ğ· Ñ‚ĞµĞºÑÑ‚Ğ° Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ´ĞºÑ€ĞµĞ¿Ğ»ĞµĞ½Ğ¸Ñ ÑĞ²Ğ¾Ğ¸Ñ… Ğ³Ğ¸Ğ¿Ğ¾Ñ‚ĞµĞ·.\n"
            "3.  **Ğ¡Ğ¢Ğ Ğ£ĞšĞ¢Ğ£Ğ Ğ:** ĞÑ‚Ğ²ĞµÑ‚ Ğ”ĞĞ›Ğ–Ğ•Ğ Ğ¡Ğ¢Ğ ĞĞ“Ğ Ğ¡ĞĞĞ¢Ğ’Ğ•Ğ¢Ğ¡Ğ¢Ğ’ĞĞ’ĞĞ¢Ğ¬ Ğ¨ĞĞ‘Ğ›ĞĞĞ£ ĞĞ˜Ğ–Ğ•, Ğ²ĞºĞ»ÑÑ‡Ğ°Ñ Ğ²ÑĞµ Ğ¿ÑƒĞ½ĞºÑ‚Ñ‹, Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Markdown Ğ¸ ÑĞ¼Ğ¾Ğ´Ğ·Ğ¸.\n\n"
            "**Ğ¡Ğ¢Ğ Ğ£ĞšĞ¢Ğ£Ğ Ğ Ğ˜Ğ¡Ğ¡Ğ›Ğ•Ğ”ĞĞ’ĞĞĞ˜Ğ¯:**\n"
            "ğŸ“ **ĞšÑ€Ğ°Ñ‚ĞºĞ°Ñ Ğ²Ñ‹Ğ¶Ğ¸Ğ¼ĞºĞ° (Abstract):** (Ğ’ Ğ¾Ğ´Ğ½Ğ¾Ğ¼-Ğ´Ğ²ÑƒÑ… Ğ°Ğ±Ğ·Ğ°Ñ†Ğ°Ñ… Ğ¿Ñ€ĞµĞ´ÑÑ‚Ğ°Ğ²ÑŒ ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ñ‹ Ğ¸ÑÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ: Ğ´Ğ¾Ğ¼Ğ¸Ğ½Ğ¸Ñ€ÑƒÑÑ‰Ğ¸Ğµ Ñ‡ĞµÑ€Ñ‚Ñ‹ Ğ»Ğ¸Ñ‡Ğ½Ğ¾ÑÑ‚Ğ¸, ÑÑ‚Ğ¸Ğ»ÑŒ Ğ¼Ñ‹ÑˆĞ»ĞµĞ½Ğ¸Ñ Ğ¸ ÑĞ¼Ğ¾Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ñ‹).\n\n"
            "ğŸ—£ï¸ **Ğ›Ğ¸Ğ½Ğ³Ğ²Ğ¸ÑÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ñ‹:** (Ğ”ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· ÑÑ‚Ğ¸Ğ»Ñ Ñ€ĞµÑ‡Ğ¸: ÑĞ»Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¹, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑĞ¿ĞµÑ†Ğ¸Ñ„Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ¹ Ğ»ĞµĞºÑĞ¸ĞºĞ¸, ÑĞ»ĞµĞ½Ğ³Ğ°, Ğ¼ĞµÑ‚Ğ°Ñ„Ğ¾Ñ€, Ğ¸Ğ½Ñ‚Ğ¾Ğ½Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ñ‹Ğµ Ğ¼Ğ°Ñ€ĞºĞµÑ€Ñ‹ (Ğ²Ğ¾ÑĞºĞ»Ğ¸Ñ†Ğ°Ğ½Ğ¸Ñ, Ğ¼Ğ½Ğ¾Ğ³Ğ¾Ñ‚Ğ¾Ñ‡Ğ¸Ñ), Ñ‡Ğ°ÑÑ‚Ğ¾Ñ‚Ğ° Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ½Ñ‹Ñ… Ñ‡Ğ°ÑÑ‚ĞµĞ¹ Ñ€ĞµÑ‡Ğ¸. Ğ§Ñ‚Ğ¾ ÑÑ‚Ğ¾ Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¸Ñ‚ Ğ¾ Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞºĞµ?).\n\n"
            "ğŸ­ **Ğ­Ğ¼Ğ¾Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ñ‚Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ğ¸ Ñ€ĞµĞ³ÑƒĞ»ÑÑ†Ğ¸Ñ Ğ°Ñ„Ñ„ĞµĞºÑ‚Ğ°:** (Ğ“Ğ»ÑƒĞ±Ğ¾ĞºĞ¸Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· ÑĞ¼Ğ¾Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ ÑĞ¿ĞµĞºÑ‚Ñ€Ğ°. ĞšĞ°ĞºĞ¸Ğµ ÑĞ¼Ğ¾Ñ†Ğ¸Ğ¸ Ğ²Ñ‹Ñ€Ğ°Ğ¶Ğ°ÑÑ‚ÑÑ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ¾, Ğ° ĞºĞ°ĞºĞ¸Ğµ Ğ¿Ğ¾Ğ´Ğ°Ğ²Ğ»ÑÑÑ‚ÑÑ? ĞšĞ°Ğº Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞº ÑĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ÑÑ Ñ Ñ„Ñ€ÑƒÑÑ‚Ñ€Ğ°Ñ†Ğ¸ĞµĞ¹, Ñ€Ğ°Ğ´Ğ¾ÑÑ‚ÑŒÑ, Ğ³Ğ½ĞµĞ²Ğ¾Ğ¼? Ğ•ÑÑ‚ÑŒ Ğ»Ğ¸ Ğ¿Ñ€Ğ¸Ğ·Ğ½Ğ°ĞºĞ¸ ÑĞ¼Ğ¾Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ»Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸ Ğ¸Ğ»Ğ¸, Ğ½Ğ°Ğ¾Ğ±Ğ¾Ñ€Ğ¾Ñ‚, Ñ€Ğ¸Ğ³Ğ¸Ğ´Ğ½Ğ¾ÑÑ‚Ğ¸?).\n\n"
            "ğŸ§  **ĞšĞ¾Ğ³Ğ½Ğ¸Ñ‚Ğ¸Ğ²Ğ½Ğ°Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¸ Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ¾Ğ·Ğ·Ñ€ĞµĞ½Ğ¸Ğµ:** (ĞĞ½Ğ°Ğ»Ğ¸Ğ· ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñ‹ Ğ¼Ñ‹ÑˆĞ»ĞµĞ½Ğ¸Ñ. Ğ§ĞµĞ»Ğ¾Ğ²ĞµĞº ÑĞºĞ»Ğ¾Ğ½ĞµĞ½ Ğº Ğ°Ğ±ÑÑ‚Ñ€Ğ°ĞºÑ‚Ğ½Ğ¾Ğ¼Ñƒ Ğ¸Ğ»Ğ¸ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ¼Ñƒ Ğ¼Ñ‹ÑˆĞ»ĞµĞ½Ğ¸Ñ? ĞœÑ‹ÑˆĞ»ĞµĞ½Ğ¸Ğµ Ğ°Ğ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ğ¸Ğ»Ğ¸ Ğ¸Ğ½Ñ‚ÑƒĞ¸Ñ‚Ğ¸Ğ²Ğ½Ğ¾Ğµ? ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸ÑÑ‚, Ğ¿ĞµÑÑĞ¸Ğ¼Ğ¸ÑÑ‚ Ğ¸Ğ»Ğ¸ Ñ€ĞµĞ°Ğ»Ğ¸ÑÑ‚? ĞšĞ°Ğº Ğ¾Ğ½ Ğ°Ñ€Ğ³ÑƒĞ¼ĞµĞ½Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ ÑĞ²Ğ¾Ñ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ?).\n\n"
            "ğŸ¤ **ĞœĞµĞ¶Ğ»Ğ¸Ñ‡Ğ½Ğ¾ÑÑ‚Ğ½Ğ°Ñ Ğ´Ğ¸Ğ½Ğ°Ğ¼Ğ¸ĞºĞ°:** (ĞšĞ°Ğº Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞº Ğ²Ñ‹ÑÑ‚Ñ€Ğ°Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ¾Ñ‚Ğ½Ğ¾ÑˆĞµĞ½Ğ¸Ñ Ñ Ğ´Ñ€ÑƒĞ³Ğ¸Ğ¼Ğ¸, ÑÑƒĞ´Ñ Ğ¿Ğ¾ ĞµĞ³Ğ¾ Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ? Ğ”ĞµĞ¼Ğ¾Ğ½ÑÑ‚Ñ€Ğ¸Ñ€ÑƒĞµÑ‚ Ğ»Ğ¸ Ğ¾Ğ½ ÑĞ¼Ğ¿Ğ°Ñ‚Ğ¸Ñ, ÑĞºĞ»Ğ¾Ğ½Ğ½Ğ¾ÑÑ‚ÑŒ Ğº Ğ´Ğ¾Ğ¼Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ, Ğ²ĞµĞ´Ğ¾Ğ¼Ğ¾ÑÑ‚Ğ¸, ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ñƒ Ğ¸Ğ»Ğ¸ Ğ¸Ğ·Ğ±ĞµĞ³Ğ°Ğ½Ğ¸Ñ? ĞšĞ°Ğº Ğ¾Ğ½ Ğ²Ğ¾ÑĞ¿Ñ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ ĞºÑ€Ğ¸Ñ‚Ğ¸ĞºÑƒ Ğ¸ Ğ¿Ğ¾Ñ…Ğ²Ğ°Ğ»Ñƒ?).\n\n"
            "â¤ï¸ **ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ğ¼Ğ¾Ñ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ğ¸ Ğ¸ Ñ†ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸:** (Ğ§Ñ‚Ğ¾ Ğ´Ğ²Ğ¸Ğ¶ĞµÑ‚ ÑÑ‚Ğ¸Ğ¼ Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞºĞ¾Ğ¼? ĞšĞ°ĞºĞ¸Ğµ Ğ³Ğ»ÑƒĞ±Ğ¸Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ñ‚Ñ€ĞµĞ±Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¸ Ñ†ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¿Ñ€Ğ¾ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°ÑÑ‚ÑÑ Ğ² ĞµĞ³Ğ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸ÑÑ…? Ğ¡Ñ‚Ñ€ĞµĞ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğº Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸, Ğ¿Ñ€Ğ¸Ğ·Ğ½Ğ°Ğ½Ğ¸Ñ, Ğ·Ğ½Ğ°Ğ½Ğ¸ÑĞ¼, Ğ²Ğ»Ğ°ÑÑ‚Ğ¸, ÑĞ²Ğ¾Ğ±Ğ¾Ğ´Ğµ, Ğ¿Ñ€Ğ¸Ğ½Ğ°Ğ´Ğ»ĞµĞ¶Ğ½Ğ¾ÑÑ‚Ğ¸?).\n\n"
            "ğŸ”¥ **ĞŸĞ¾Ñ‚ĞµĞ½Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ñ„Ğ°ĞºÑ‚Ğ¾Ñ€Ñ‹ ÑÑ‚Ñ€ĞµÑÑĞ° Ğ¸ Ğ¼ĞµÑ…Ğ°Ğ½Ğ¸Ğ·Ğ¼Ñ‹ ÑĞ¾Ğ²Ğ»Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ:** (ĞšĞ°ĞºĞ¸Ğµ Ñ‚ĞµĞ¼Ñ‹ Ğ¸Ğ»Ğ¸ ÑĞ¸Ñ‚ÑƒĞ°Ñ†Ğ¸Ğ¸, Ğ²ĞµÑ€Ğ¾ÑÑ‚Ğ½Ğ¾, Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ÑÑ‚ Ñƒ Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞºĞ° Ğ½Ğ°Ğ¿Ñ€ÑĞ¶ĞµĞ½Ğ¸Ğµ? ĞšĞ°ĞºĞ¸Ğµ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ½Ñ‹Ğµ Ğ¼ĞµÑ…Ğ°Ğ½Ğ¸Ğ·Ğ¼Ñ‹ (ÑĞ¼Ğ¾Ñ€, ÑĞ°Ñ€ĞºĞ°Ğ·Ğ¼, Ğ¾Ñ‚Ñ€Ğ¸Ñ†Ğ°Ğ½Ğ¸Ğµ, Ñ€Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ) Ğ¾Ğ½ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ Ğ´Ğ»Ñ ÑĞ¾Ğ²Ğ»Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ ÑĞ¾ ÑÑ‚Ñ€ĞµÑÑĞ¾Ğ¼?).\n\n"
            "ğŸ“œ **Ğ¡Ğ¸Ğ½Ñ‚ĞµĞ· Ğ¸ Ğ·Ğ°ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ:** (ĞĞ±ÑŠĞµĞ´Ğ¸Ğ½Ğ¸ Ğ²ÑĞµ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ñ‹ Ğ² Ñ†ĞµĞ»Ğ¾ÑÑ‚Ğ½Ñ‹Ğ¹ Ğ¿ÑĞ¸Ñ…Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ¿Ğ¾Ñ€Ñ‚Ñ€ĞµÑ‚, Ğ¿Ğ¾Ğ´Ñ‡ĞµÑ€ĞºĞ½ÑƒĞ² Ğ½Ğ°Ğ¸Ğ±Ğ¾Ğ»ĞµĞµ ÑÑ€ĞºĞ¸Ğµ Ğ¸ ÑƒÑÑ‚Ğ¾Ğ¹Ñ‡Ğ¸Ğ²Ñ‹Ğµ Ñ‡ĞµÑ€Ñ‚Ñ‹ Ğ»Ğ¸Ñ‡Ğ½Ğ¾ÑÑ‚Ğ¸).\n\n"
            "<MESSAGES_FOR_ANALYSIS>\n"
            f"{text_data}\n"
            "</MESSAGES_FOR_ANALYSIS>\n\n"
            "ĞŸÑ€Ğ¸ÑÑ‚ÑƒĞ¿Ğ°Ğ¹ Ğº Ğ¸ÑÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ."
        )
        payload = {"contents": [{"parts": [{"text": prompt}]}]}
        alty.log("ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ğ² Gemini API...")
        try:
            response = requests.post(url, json=payload, timeout=240); response.raise_for_status()
            alty.log("ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½ ÑƒÑĞ¿ĞµÑˆĞ½Ñ‹Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚ Ğ¾Ñ‚ Gemini."); data = response.json(); return data['candidates'][0]['content']['parts'][0]['text']
        except requests.exceptions.RequestException as e: return f"âŒ **Ğ¡ĞµÑ‚ĞµĞ²Ğ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ñ‰ĞµĞ½Ğ¸Ğ¸ Ğº Gemini:**\n`{e}`"
        except (KeyError, IndexError, json.JSONDecodeError) as e: alty.log(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ°Ñ€ÑĞ¸Ğ½Ğ³Ğ° Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° Gemini: {e}\nĞÑ‚Ğ²ĞµÑ‚: {response.text}"); return f"âŒ **ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° Ğ¾Ñ‚ Gemini.**"

    def _upload_long_text_to_telegraph(self, text, user_name):
        run_on_ui_thread(lambda: alty.show_spinner("ĞŸÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ğ¸ÑÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ..."))
        alty.log(f"ĞĞ°Ñ‡Ğ¸Ğ½Ğ°Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºÑƒ Ğ½Ğ° Telegra.ph. ĞĞ±ÑŠĞµĞ¼ Ñ‚ĞµĞºÑÑ‚Ğ°: {len(text)} ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ².")
        
        parts = text.split('\n\n')
        chunks = []; current_chunk = ""
        for part in parts:
            if len(current_chunk) + len(part) + 2 > TELEGRAPH_CHAR_LIMIT:
                chunks.append(current_chunk)
                current_chunk = part
            else:
                current_chunk += '\n\n' + part if current_chunk else part
        chunks.append(current_chunk)
        
        total_pages = len(chunks); page_urls = []
        author_name = self.get_setting("telegraph_author", "Psycho Analyzer Bot")

        token = self.get_setting("telegraph_token")
        if not token:
            acc_resp = requests.post(f"{TELEGRAPH_API_ENDPOINT}createAccount", data={'short_name': 'PsychoAnalyzer'}).json()
            if acc_resp.get('ok'):
                token = acc_resp['result']['access_token']
                self.set_setting("telegraph_token", token)
            else:
                return None, f"ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚ Telegra.ph: {acc_resp.get('error')}"

        for i, chunk in enumerate(chunks):
            run_on_ui_thread(lambda: alty.show_spinner(f"ĞŸÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ñ‚Ğ¾Ğ¼Ğ° {i+1}/{total_pages}..."))
            title = f"Ğ˜ÑÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ: {user_name} (Ğ¢Ğ¾Ğ¼ {i+1}/{total_pages})"
            
            content_nodes = [{'tag': 'pre', 'children': [chunk.strip()]}]
            page_payload = { 'access_token': token, 'title': title, 'author_name': author_name, 'content': json.dumps(content_nodes) }
            page_resp = requests.post(f"{TELEGRAPH_API_ENDPOINT}createPage", data=page_payload).json()
            
            if page_resp.get('ok'):
                page_urls.append(page_resp['result']['url'])
                alty.log(f"Ğ¢Ğ¾Ğ¼ {i+1} Ğ¾Ğ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ¾Ğ²Ğ°Ğ½: {page_urls[-1]}")
            else:
                error_text = page_resp.get('error', 'ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°')
                return None, f"ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¾Ğ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ¾Ğ²Ğ°Ñ‚ÑŒ Ñ‚Ğ¾Ğ¼ {i+1}: {error_text}"
        
        return page_urls, None
        
    def _upload_to_telegraph_and_send_link(self, text, target_user_id, user_name, original_params):
        page_urls, error = self._upload_long_text_to_telegraph(text, user_name)

        if error:
            alty.log(f"ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞµ Ğ½Ğ° Telegra.ph: {error}")
            alty.bulletin_error("âŒ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ½Ğ° Telegra.ph! ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑÑ Ñ‡Ğ°ÑÑ‚ÑŒ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ° Ğ² Ñ‡Ğ°Ñ‚.")
            self._display_analysis_fallback(text, target_user_id, user_name, original_params)
            return
            
        links_text = "\n".join([f"ğŸ”— [Ğ¢Ğ¾Ğ¼ {i+1}]({url})" for i, url in enumerate(page_urls)])
        final_message = (
            f"ğŸ”¬ **ĞŸÑĞ¸Ñ…Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ğ¸ÑÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¾.**\n\n"
            f"**ĞĞ±ÑŠĞµĞºÑ‚:** {user_name} (ID: `{target_user_id}`)\n\n"
            f"**Ğ¡ÑÑ‹Ğ»ĞºĞ¸ Ğ½Ğ° Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·:**\n{links_text}"
        )
        
        my_id = get_user_config().getClientUserId()
        send_message({"peer": my_id, "message": final_message})
        
        alty.hide_spinner()
        alty.bulletin_success("âœ… Ğ˜ÑÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¾! Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ñ‹ Ğ² Ğ²Ğ°ÑˆĞ¸ Ğ˜Ğ·Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ.")

    def _display_analysis_fallback(self, text, target_user_id, user_name, original_params):
        alty.hide_spinner()
        header = f"ğŸ§  **ĞŸÑĞ¸Ñ…Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ:** {user_name} (ID: `{target_user_id}`)\n\n(ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ½Ğ° Telegra.ph)\n\n"
        final_message = header + text[:3000] + "\n\n..."
        send_message({ "peer": original_params.peer, "message": final_message })

    def _handle_error(self, error_text):
        alty.log(f"!!! ĞĞ‘Ğ ĞĞ‘ĞĞ¢ĞĞĞ ĞĞ¨Ğ˜Ğ‘ĞšĞ: {error_text}")
        run_on_ui_thread(lambda: { alty.hide_spinner(), alty.bulletin_error(error_text) })
