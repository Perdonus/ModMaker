"""
>>==================================================================<<
||    ____           _             ____  _             _            ||
||   / ___|__ _  ___| |_ _   _ ___|  _ \| |_   _  __ _(_)_ __  ___  ||
||  | |   / _` |/ __| __| | | / __| |_) | | | | |/ _` | | '_ \/ __| ||
||  | |__| (_| | (__| |_| |_| \__ \  __/| | |_| | (_| | | | | \__ \ ||
||   \____\__,_|\___|\__|\__,_|___/_|   |_|\__,_|\__, |_|_| |_|___/ ||
||     ____           _ _   _     _              |___/              ||
||    / __ \__      _(_) |_| |__ | | _____   _____                  ||
||   / / _` \ \ /\ / / | __| '_ \| |/ _ \ \ / / _ \                 ||
||  | | (_| |\ V  V /| | |_| | | | | (_) \ V /  __/                 ||
||   \ \__,_| \_/\_/ |_|\__|_| |_|_|\___/ \_/ \___|                 ||
||                                                                  ||
||                   https://t.me/CactusPlugins                     ||
||     https://github.com/Den4ikSuperOstryyPer4ik/CactusPlugins     ||
||                                                                  ||
||          ПОЖАЛУЙСТА НЕ КОПИРУЙТЕ КОД НЕ УВЕДОМИВ МЕНЯ.           ||
||        PLEASE DO NOT COPY THIS CODE WITHOUT NOTIFYING ME.        ||
>>==================================================================<<
"""
__name__ = "All Telegram Icons"
__description__ = """
Fork DevSettingsIcons, который показывает все иконки и части интерфейса, которые можно заменить с помощью файл.icons

Предупреждение:
Иконки по типу ft_avd_tooverflow_animation и ft_avd_toarrow_animation не используте в паках, чтобы избежать краша клиента.
"""
__icon__ = "AnimatedMiratsu/1"
__id__ = "all_dev_icons"
__version__ = "1.0.0"
__author__ = "@CactusPlugins (автор) & @mur_live (форкер)"
__min_version__ = "12.1.1"

import traceback
import os

from android.content import DialogInterface
from android.text import SpannableStringBuilder
from android.util import TypedValue
from android.view import Gravity, View
from android.widget import (FrameLayout, ImageView, LinearLayout, ScrollView,
                            TextView)
from android_utils import log
from android_utils import log as logcat
from android_utils import run_on_ui_thread
from androidx.appcompat.widget import AppCompatImageView
from androidx.core.content import ContextCompat
from base_plugin import BasePlugin
from client_utils import get_last_fragment, run_on_queue
from com.exteragram.messenger.icons import ExteraResources
from com.exteragram.messenger.preferences.components import AltSeekbar
from java import dynamic_proxy
from org.telegram.messenger import AndroidUtilities, R, Utilities
from org.telegram.ui.ActionBar import AlertDialog, BottomSheet, Theme
from org.telegram.ui.Components import (ColoredImageSpan, LayoutHelper,
                                        RLottieImageView, UItem,
                                        UniversalRecyclerView)
from org.telegram.ui.Stories.recorder import ButtonWithCounterView
from ui.bulletin import BulletinHelper
from ui.settings import Divider, Header, Input, Selector, Text

dp = AndroidUtilities.dp

def gen(java_class, method_name: str, return_value: bool = False, default_value=None):
    def _run(instance, *java_args):
        try:
            value = instance._fn(*java_args, *instance._args, **instance._kwargs)
            if return_value:
                return value
        except Exception:
            logcat("[ERROR] [ElyxCore] " + traceback.format_exc())
            return default_value

    def __init__(self, fn, *args, **kwargs):
        self._fn = fn
        self._args = args
        self._kwargs = kwargs
        super(type(self), self).__init__()

    NewClass = type('GeneratedProxyClass_' + java_class.__name__, (dynamic_proxy(java_class),), {
        '__init__': __init__,
        method_name: _run,
    })

    return NewClass


def gen2(java_class, return_value: bool = False, **methods):
    def _run(method: callable):
        def _fn(instance, *java_args):
            try:
                value = method(*java_args, *instance._args, **instance._kwargs)
                if return_value:
                    return value
            except Exception:
                logcat("[ERROR] [ElyxCore]" + traceback.format_exc())

        return _fn

    def __init__(self, *args, **kwargs):
        self._args = args
        self._kwargs = kwargs
        super(type(self), self).__init__()

    NewClass = type('GeneratedProxyClass_' + java_class.__name__, (dynamic_proxy(java_class),), {
        '__init__': __init__,
        **{
            method_name: _run(method)
            for method_name, method in methods.items()
        },
    })

    return NewClass

strings = {
    "icons": "Иконки (R.drawable)",
    "animations": "Анимации (R.raw)",
    "filters": "Фильтры",
    "search": "Поиск",
    "type": "Тип иконок",
    "all": "Все",
    "show_as_grid": "Показать в виде плитки",
    "show_as_list": "Показать в виде списка",
    "loading": "Загрузка...",
    "icon_size": "Размер иконки",
    "animation_size": "Размер анимации",
    "min": "МИН",
    "max": "МАКС",
    "pause": "Остановить",
    "play": "Запустить",
    "export_list": "Сохранить список в файл",
    "export_done": "Список сохранен в: {}",
    "export_error": "Ошибка при сохранении: {}",
    "other": "Другое"
}

_types = {
    1: "Solar",
    2: "Remix",
    3: "Default"
}

Callback2 = gen(Utilities.Callback2, "run")
Callback5 = gen(Utilities.Callback5, "run")
OnClickListener = gen(View.OnClickListener, "onClick")
OnDismissListener = gen(DialogInterface.OnDismissListener, "onDismiss")

class ResourcesBottomSheet:
    title = ""
    filter_setting = ""
    type_setting = ""

    def __init__(self, lib, vtype):
        self.lib = lib
        self.vtype = vtype
        self.fragment = get_last_fragment()
        self.activity = self.fragment.getParentActivity()
        self.context = self.fragment.getContext()

        self._loaded = False
        self._items = []
        self.count = 0
        self.filter = self.lib.get_setting(self.filter_setting, "").lower()

        self.builder = None
        self.bottomSheet = None

        run_on_queue(lambda: self._load_all())

    def _load_all(self):
        pass

    def fill_items(self, items, adapter):
        try:
            _type = self.lib.get_setting(self.type_setting, 0) if self.type_setting else None
            title = self.title + (" • " + self.filter if self.filter else "") + (" • " + _types[_type] if _type and _type != 0 else "")

            if not self._loaded:
                items.add(UItem.asHeader(strings["loading"]))
            else:
                for item in self._items:
                    items.add(item)
                
                title += f" ({self.count})"

            (self.bottomSheet if self.bottomSheet else self.builder).setTitle(title, True)
        except:
            items.add(UItem.asShadow(traceback.format_exc()))

    def on_click(self, *_):
        pass

    def show(self):
        self.builder = builder = BottomSheet.Builder(self.activity)

        builder.setApplyTopPadding(False)
        builder.setApplyBottomPadding(False)

        contentView = FrameLayout(self.activity)
        builder.setCustomView(contentView)

        contentView.setBackgroundColor(Theme.getColor(Theme.key_windowBackgroundGray))

        self.listView = listView = UniversalRecyclerView(self.fragment, Callback2(self.fill_items), Callback5(self.on_click), None)
        contentView.addView(listView, LayoutHelper.createFrame(-1, 700))

        self.bottomSheet = builder.show()
        self.bottomSheet.setCanDismissWithSwipe(False)


class IconsSheet(ResourcesBottomSheet):
    title = strings["icons"]
    filter_setting = "icon_filter"
    type_setting = "icon_type"

    def _load_all(self):
        if self._loaded:
            return
    
        try:
            _filter = self.filter
            _type = self.lib.get_setting(self.type_setting, 0)

            try:
                exteraResources = self.context.getResources()
                if not isinstance(exteraResources, ExteraResources):
                    exteraResources = ExteraResources(exteraResources)
            except:
                logcat(traceback.format_exc())
                exteraResources = None
            
            if self.vtype == 0:
                linear_layout = LinearLayout(self.activity)

                width = self.context.getResources().getDisplayMetrics().widthPixels
                icon_width = (64 + AndroidUtilities.dp(28 + 7))
                row_size = width // icon_width

                frame = LayoutHelper.createFrame(64, 64, 0, 0, 0, int((width - icon_width*row_size) / row_size), 0)
                scale = ImageView.ScaleType.CENTER

                k = 0

                for icon, icon_res_id in self.lib.icons.items():
                    try:
                        if _filter:
                            if _filter not in icon:
                                continue

                        if _type != 0:
                            if _type == 1 and "solar" not in icon:
                                continue
                            elif _type == 2 and "remix" not in icon:
                                continue
                            elif (
                                _type == 3
                                and (
                                    ("solar" in icon or "remix" in icon)
                                    or not (
                                        f"{icon}_remix" in self.lib.icons
                                        or f"{icon}_solar" in self.lib.icons
                                    )
                                )
                            ):
                                continue
                        
                        k += 1
                        self.count += 1

                        icb = AppCompatImageView(self.activity)
                        icb.setScaleType(scale)
                        icb.setImageDrawable((exteraResources.getOriginalDrawable(icon_res_id) if exteraResources else ContextCompat.getDrawable(self.activity, icon_res_id)).mutate())
                        icb.setBackground(Theme.createSelectorDrawable(Theme.getColor(Theme.key_dialogButtonSelector), 1, AndroidUtilities.dp(28)))
                        icb.setOnClickListener(OnClickListener(self.open_icon(icon)))
                        linear_layout.addView(icb, frame)

                        if k == row_size:
                            self._items.append(UItem.asCustom(linear_layout))
                            linear_layout = LinearLayout(self.activity)
                            k = 0
                    except:
                        self.lib.log(f"Icon {icon} is not found: {traceback.format_exc()}")
                
                if k != 0:
                    self._items.append(UItem.asCustom(linear_layout))
            elif self.vtype == 1:
                for icon, icon_res_id in self.lib.icons.items():
                    try:
                        if _filter:
                            if _filter not in icon:
                                continue

                        if _type != 0:
                            if _type == 1 and "solar" not in icon:
                                continue
                            elif _type == 2 and "remix" not in icon:
                                continue
                            elif (
                                _type == 3
                                and (
                                    ("solar" in icon or "remix" in icon)
                                    or not (
                                        f"{icon}_remix" in self.lib.icons
                                        or f"{icon}_solar" in self.lib.icons
                                    )
                                )
                            ):
                                continue
                        
                        drawable = (exteraResources.getOriginalDrawable(icon_res_id) if exteraResources else ContextCompat.getDrawable(self.activity, icon_res_id)).mutate()
                        self._items.append(UItem.asButton(0, drawable, icon))
                        self.count += 1
                    except:
                        self.lib.log(f"Icon {icon} is not found: {traceback.format_exc()}")
        except:
            self.items.append(UItem.asShadow(traceback.format_exc()))
        
        self._loaded = True
        run_on_ui_thread(lambda: self.listView.adapter.update(True))
    
    def open_icon(self, icon):
        def _fn(_=None):
            try:
                show_icon_full(self.activity, icon)
            except:
                logcat(traceback.format_exc())
        return _fn

    def on_click(self, item, *_):
        if self.vtype == 1:
            self.open_icon(item.text)()


class AnimationSheet(ResourcesBottomSheet):
    title = strings["animations"]
    filter_setting = "animation_filter"

    def _load_all(self):
        if self._loaded:
            return
    
        self.all = []
        try:
            _filter = self.filter

            try:
                exteraResources = self.context.getResources()
                if not isinstance(exteraResources, ExteraResources):
                    exteraResources = ExteraResources(exteraResources)
            except:
                logcat(traceback.format_exc())
                exteraResources = None
            
            scale = ImageView.ScaleType.CENTER

            if self.vtype == 0:
                linear_layout = LinearLayout(self.activity)

                width = self.context.getResources().getDisplayMetrics().widthPixels
                icon_width = (AndroidUtilities.dp(56))
                row_size = width // icon_width - 1

                frame = LayoutHelper.createFrame(48, 48, 0, 0, 0, int((width - icon_width*row_size) / row_size), 0)

                k = 0

                for animation, anim_res_id in self.lib.animations.items():
                    try:
                        if _filter:
                            if _filter not in animation:
                                continue

                        k += 1
                        self.count += 1

                        icb = RLottieImageView(self.activity)
                        icb.setScaleType(scale)
                        icb.setAutoRepeat(True)
                        icb.setAnimation(anim_res_id, 46, 46)
                        icb.playAnimation()
                        icb.setBackground(Theme.createSelectorDrawable(Theme.getColor(Theme.key_dialogButtonSelector), 1, AndroidUtilities.dp(28)))
                        icb.setOnClickListener(OnClickListener(self.open_animation(animation)))
                        linear_layout.addView(icb, frame)

                        self.all.append(icb)

                        if k == row_size:
                            self._items.append(UItem.asCustom(linear_layout))
                            linear_layout = LinearLayout(self.activity)
                            k = 0
                    except:
                        self.lib.log(f"Animation {animation} is not found: {traceback.format_exc()}")
                
                if k != 0:
                    self._items.append(UItem.asCustom(linear_layout))
            elif self.vtype == 1:
                frame = LayoutHelper.createFrame(48, 48, 0, 8, 4, 0, 4)
                frame2 = LayoutHelper.createFrame(-2, -2, Gravity.CENTER_VERTICAL, 12, 0, 0, 0)
                text_color = Theme.getColor(Theme.key_windowBackgroundWhiteBlackText)

                for animation, anim_res_id in self.lib.animations.items():
                    try:
                        if _filter:
                            if _filter not in animation:
                                continue

                        layout = LinearLayout(self.activity)
                        
                        icb = RLottieImageView(self.activity)
                        icb.setScaleType(scale)
                        icb.setAutoRepeat(True)
                        icb.setAnimation(anim_res_id, 46, 46)
                        icb.playAnimation()
                        self.all.append(icb)
                        layout.addView(icb, frame)

                        text_view = TextView(self.activity)
                        text_view.setTextColor(text_color)
                        text_view.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 18)
                        text_view.setGravity(Gravity.CENTER_VERTICAL)
                        text_view.setText(animation)
                        layout.addView(text_view, frame2)

                        item = UItem.asCustom(layout)
                        item.object2 = animation
                        self._items.append(item)
                        self.count += 1
                    except:
                        self.lib.log(f"Animation {animation} is not found: {traceback.format_exc()}")
        except:
            self.items.append(UItem.asShadow(traceback.format_exc()))
        
        self._loaded = True
        run_on_ui_thread(lambda: self.listView.adapter.update(True))
    
    def open_animation(self, anim):
        def _fn(_=None):
            try:
                for dr in self.all:
                    dr.stopAnimation()
                
                def play_all():
                    for dr in self.all:
                        dr.playAnimation()
                
                show_full_animation(self.activity, anim, play_all)
            except:
                logcat(traceback.format_exc())
        return _fn

    def on_click(self, item, *_):
        if self.vtype == 1:
            self.open_animation(item.object2)()


def show_icon_full(activity, icon):
    try:
        builder = AlertDialog.Builder(activity)

        frameLayout = FrameLayout(activity)
        builder.setView(frameLayout)

        scrollView = ScrollView(activity)
        scrollView.setFillViewport(True)
        frameLayout.addView(scrollView, LayoutHelper.createFrame(-1, -1))

        linearLayout = LinearLayout(activity)
        linearLayout.setOrientation(LinearLayout.VERTICAL)
        linearLayout.setGravity(Gravity.CENTER_HORIZONTAL)
        scrollView.addView(linearLayout, LayoutHelper.createFrame(-1, -2, Gravity.LEFT | Gravity.TOP))

        lockImageView = RLottieImageView(activity)
        lockImageView.setImageResource(getattr(R.drawable, icon))
        linearLayout.addView(lockImageView, LayoutHelper.createLinear(256, 256, Gravity.CENTER_HORIZONTAL))

        def on_change(p):
            lockImageView.setLayoutParams(LayoutHelper.createLinear(int(p), int(p)))
            lockImageView.invalidate()
            seek.invalidate()

        seek = AltSeekbar(activity, gen(AltSeekbar.OnDrag, "run")(lambda p: on_change(p)), 24, 256, strings["icon_size"], strings["min"], strings["max"])
        seek.setProgress(1)
        linearLayout.addView(seek, LayoutHelper.createLinear(-1, -2))

        copy_button = ButtonWithCounterView(activity, False, None)
        span = ColoredImageSpan(ContextCompat.getDrawable(activity, R.drawable.msg_copy))
        string_builder = SpannableStringBuilder()
        string_builder.append("d ").setSpan(span, 0, 1, 0)
        string_builder.append(icon)
        copy_button.setText(string_builder, False)
        copy_button.setOnClickListener(OnClickListener(
            lambda _: (
                BulletinHelper.show_copied_to_clipboard()
                if AndroidUtilities.addToClipboard(icon)
                else None
            )
        ))

        linearLayout.addView(copy_button, LayoutHelper.createLinear(-1, 48, 0, 16, 28, 16, 16))

        dialog = builder.create()
        dialog.show()
    except:
        log(traceback.format_exc())


def show_full_animation(activity, animation, play_all):
    try:
        builder = AlertDialog.Builder(activity)

        frameLayout = FrameLayout(activity)
        builder.setView(frameLayout)

        scrollView = ScrollView(activity)
        scrollView.setFillViewport(True)
        frameLayout.addView(scrollView, LayoutHelper.createFrame(-1, -1))

        linearLayout = LinearLayout(activity)
        linearLayout.setOrientation(LinearLayout.VERTICAL)
        linearLayout.setGravity(Gravity.CENTER_HORIZONTAL)
        scrollView.addView(linearLayout, LayoutHelper.createFrame(-1, -2, Gravity.LEFT | Gravity.TOP))

        animationView = RLottieImageView(activity)
        animationView.setAutoRepeat(True)
        animationView.setAnimation(getattr(R.raw, animation), 256, 256)
        animationView.playAnimation()
        linearLayout.addView(animationView, LayoutHelper.createLinear(256, 256, Gravity.CENTER_HORIZONTAL))

        def on_change(p):
            animationView.setLayoutParams(LayoutHelper.createLinear(int(p), int(p)))
            animationView.invalidate()
            seek.invalidate()

        seek = AltSeekbar(activity, gen(AltSeekbar.OnDrag, "run")(lambda p: on_change(p)), 24, 256, strings["animation_size"], strings["min"], strings["max"])
        seek.setProgress(1)
        linearLayout.addView(seek, LayoutHelper.createLinear(-1, -2))

        def on_click(_=None, first: bool = False):
            if not first:
                if animationView.isPlaying():
                    animationView.stopAnimation()
                else:
                    animationView.playAnimation()
            
            span = ColoredImageSpan(ContextCompat.getDrawable(activity, R.drawable.msg_round_pause_m if first or animationView.isPlaying() else R.drawable.msg_round_play_m))
            string_builder = SpannableStringBuilder()
            string_builder.append("d ").setSpan(span, 0, 1, 0)
            string_builder.append(strings["pause"] if first or animationView.isPlaying() else strings["play"])
            play_button.setText(string_builder, False)
        
        play_button = ButtonWithCounterView(activity, True, None)
        play_button.setOnClickListener(OnClickListener(on_click))
        on_click(None, True)
        linearLayout.addView(play_button, LayoutHelper.createLinear(-1, 48, 0, 16, 28, 16, 4))

        copy_button = ButtonWithCounterView(activity, False, None)
        span = ColoredImageSpan(ContextCompat.getDrawable(activity, R.drawable.msg_copy))
        string_builder = SpannableStringBuilder()
        string_builder.append("d ").setSpan(span, 0, 1, 0)
        string_builder.append(animation)
        copy_button.setText(string_builder, False)
        copy_button.setOnClickListener(OnClickListener(
            lambda _: (
                BulletinHelper.show_copied_to_clipboard()
                if AndroidUtilities.addToClipboard(animation)
                else None
            )
        ))
        linearLayout.addView(copy_button, LayoutHelper.createLinear(-1, 48, 0, 16, 4, 16, 8))

        builder.setOnPreDismissListener(OnDismissListener(lambda _: play_all()))

        dialog = builder.create()
        dialog.show()
    except:
        log(traceback.format_exc())

class DevSettingIcons(BasePlugin):
    def __init__(self):
        super().__init__()
        self.icons = {}
        self.animations = {}
        self.other = {}

    def safe_getattr(self, obj, attr, default=None):
        try:
            return getattr(obj, attr)
        except:
            return default

    def on_plugin_load(self) -> None:
        self.icons = {
            i: attr
            for i in dir(R.drawable)
            if all([x in ('abcdefghijklmnopqrstuvwxyz' + '0123456789' + '_') for x in i]) 
            and not i.startswith('_')
            and (attr := self.safe_getattr(R.drawable, i))
        }
        
        self.animations = {
            i: attr
            for i in dir(R.raw)
            if all([x in ('abcdefghijklmnopqrstuvwxyz' + '0123456789' + '_') for x in i])
            and not i.startswith('_')
            and (attr := self.safe_getattr(R.raw, i))
        }
        
        self.other = {
            i: attr
            for i in dir(R.raw)
            if all([x in ('abcdefghijklmnopqrstuvwxyz' + '0123456789' + '_') for x in i])
            and not i.startswith('_')
            and (attr := self.safe_getattr(R.raw, i))
        }

    def export_to_file(self):
        try:
            filename = "All_Telegram_Icons_List.txt"
            path = os.path.join(os.environ.get("EXTERNAL_STORAGE", "/sdcard"), "Download", filename)
            
            if not os.path.exists(os.path.dirname(path)):
                path = os.path.join(os.environ.get("EXTERNAL_STORAGE", "/sdcard"), filename)

            with open(path, "w", encoding="utf-8") as f:
                f.write("=== TELEGRAM ICONS ===\n")
                f.write(f"Всего R.drawable: {len(self.icons)}\n")
                f.write(f"Всего R.raw: {len(self.animations)}\n\n")
                for name in sorted(self.icons.keys()):
                    f.write(f"{name}\n")
                
                for name in sorted(self.animations.keys()):
                    f.write(f"{name}\n")

            BulletinHelper.show_success(strings["export_done"].format(path))
        except Exception as e:
            error_msg = str(e)
            self.log(f"Export error: {error_msg}")
            BulletinHelper.show_error(strings["export_error"].format(error_msg))

    def create_settings(self):
        return [
            Header(text=strings["icons"]),
            Input(key="icon_filter", text=strings["search"], icon="msg_search", default=""),
            Selector(
                key="icon_type",
                text=strings["type"],
                default=0,
                items=[strings["all"], "Solar", "Remix", "Default"],
                icon="menu_select_quote_solar"
            ),
            Text(
                text=strings["show_as_grid"],
                accent=True,
                on_click=lambda _: IconsSheet(self, 0).show(),
                icon="input_bot2_solar"
            ),
            Text(
                text=strings["show_as_list"],
                accent=True,
                on_click=lambda _: IconsSheet(self, 1).show(),
                icon="msg_reorder"
            ),
            
            Divider(),
            
            Header(text=strings["animations"]),
            Input(key="animation_filter", text=strings["search"], icon="msg_search", default=""),
            Text(
                text=strings["show_as_grid"],
                accent=True,
                on_click=lambda _: AnimationSheet(self, 0).show(),
                icon="input_bot2_solar"
            ),
            Text(
                text=strings["show_as_list"],
                accent=True,
                on_click=lambda _: AnimationSheet(self, 1).show(),
                icon="msg_reorder"
            ),
            
            Divider(),
            
            Header(text=strings["other"]),
            Text(
                text=strings["export_list"],
                accent=True,
                on_click=lambda _: self.export_to_file(),
                icon="msg_log_solar"
            ),
        ]
